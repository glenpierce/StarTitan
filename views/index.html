<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Star Titans</title>
</head>
<body style="background-color:black">
<br>
<div id="selectionPanel" style="border:1px solid #BBBBBB; width:100px; height:650px; position: fixed;"></div>
<div id="infoPanel" style="position: fixed;"></div>
<canvas id="myCanvas" width="1100" height="650" style="border:1px solid #000000;"></canvas>
<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    ctx.font = "10px Arial";
    ctx.textAlign = "center";
    var map;
    var clickableArea = 20;

    var selectionPanel = document.getElementById("selectionPanel");

//    var avgWhiteStar =  new Image();
//    avgWhiteStar.src = "images/averstarwhite.png"

    canvas.addEventListener("click", onClick);
    function onClick(event){
        var canvasX = event.x - canvas.offsetLeft + document.body.scrollLeft;
        var canvasY = event.y - canvas.offsetTop + document.body.scrollTop;
        exampleSocket.send("click(" + canvasX +", "+ canvasY +")");
        console.log("click(" + canvasX +", "+ canvasY +")");
        while (selectionPanel.hasChildNodes()) {
            selectionPanel.removeChild(selectionPanel.lastChild);
        }
        var selectionCount = 0;
        for(i=0; i < map.MAP.length; i++){
            if(map.MAP[i].i.x < canvasX + clickableArea && map.MAP[i].i.x > canvasX - clickableArea && map.MAP[i].i.y < canvasY + clickableArea && map.MAP[i].i.y > canvasY - clickableArea){
                if(map.MAP[i].i.type == "ship"){
                    selectionCount++;
                    drawShip(map.MAP[i].i.x, map.MAP[i].i.y, map.MAP[i].i.ships, map.MAP[i].i.destination, map.MAP[i].i.owner, true, ctx);
                } else if(map.MAP[i].i.type == "star"){
                    console.log("star clicked");
                    selectionCount++;
                    var selectedStarName = document.createElement('input');
                    selectedStarName.type = "text";
                    selectedStarName.value = map.MAP[i].i.id;
                    var selectedStarIndustry = document.createElement('button');
                    selectedStarIndustry.type = "button";
                    var selectedStarIndustryValue = parseInt(map.MAP[i].i.industry, 10);
                    selectedStarIndustry.innerHTML = selectedStarIndustryValue;
                    var selectedStarScience = document.createElement('button');
                    selectedStarScience.type = "button";
                    selectedStarScience.innerHTML = map.MAP[i].i.science;
                    var selectedStarEconomy = document.createElement('button');
                    selectedStarEconomy.type = "button";
                    selectedStarEconomy.innerHTML = map.MAP[i].i.economy;
                    var selectedStarShips = document.createElement('button');
                    selectedStarShips.type = "button";
                    selectedStarShips.innerHTML = map.MAP[i].i.ships;

                    var selectedStar = document.createElement('div');
                    selectedStar.appendChild(selectedStarName);
                    selectedStar.appendChild(selectedStarIndustry);
                    selectedStar.appendChild(selectedStarScience);
                    selectedStar.appendChild(selectedStarEconomy);
                    selectedStar.appendChild(selectedStarShips);
                    selectionPanel.appendChild(selectedStar);
                    selectedStarName.setAttribute("style","width:94px");

                    selectedStarIndustry.addEventListener("click", function(){incrementIndustry(selectedStarName.value, selectedStarIndustry, selectedStarIndustryValue)});
                }
            }
        }
        if(selectionCount < 1){
            while (selectionPanel.hasChildNodes()) {
                selectionPanel.removeChild(selectionPanel.lastChild);
            }
        }
    }

    var exampleSocket = new WebSocket("ws://localhost:3001", "echo-protocol");
    exampleSocket.onopen = function (event) {
        exampleSocket.send("Map?");
    };
    exampleSocket.onmessage = function (event) {
        if(event.data.toString().substring(2,5) == "MAP") {
            map = JSON.parse(event.data);
            clearMap(canvas, ctx);
            for(var i = 0; i < map.MAP.length; i++){
                if(map.MAP[i].i.type == "star"){
                    drawStar(map.MAP[i].i.x, map.MAP[i].i.y, map.MAP[i].i.id, map.MAP[i].i.science, map.MAP[i].i.industry, map.MAP[i].i.economy, map.MAP[i].i.ships, map.MAP[i].i.owner, ctx);
                }
                if(map.MAP[i].i.type == "ship"){
                    drawShip(map.MAP[i].i.x, map.MAP[i].i.y, map.MAP[i].i.ships, map.MAP[i].i.destination, map.MAP[i].i.owner, false, ctx);
                }
            }
        }
    };

    function incrementIndustry(starName, selectedStarIndustry, selectedStarIndustryValue){
        for(i=0; i < map.MAP.length; i++) {
            if(map.MAP[i].i.id == starName){
                map.MAP[i].i.industry += 1;
                selectedStarIndustry.innerHTML = map.MAP[i].i.industry;
                console.log("increment industry" + starName);
                var order = {order:[]};
                order.order.push({
                    id: starName,
                    type: "increment", //change research target, transmit ship orders, send player message/credits/tech
                    ships: "0",
                    destination: "null",
                    science: "0",
                    industry: "1",
                    economy: "0",
                    owner: "me"
                });
                exampleSocket.send(JSON.stringify(order));
                break;
            }
        }
    }

    function drawStar(x, y, name, science, industry, economy, ships, owner, ctx){
        ctx.fillStyle="#FFFFFF";
        x = parseInt(x, 10);
        y = parseInt(y, 10);
        owner = parseInt(owner, 10);
        ctx.fillText(name, x, y + 15);
        ctx.fillText(economy, x - 7, y - 12);
        ctx.fillText(industry, x, y - 12);
        ctx.fillText(science, x + 7, y - 12);
        ships = parseInt(ships,10);
        if(ships > 0){
            ctx.fillText(ships, x, y + 23);
        }
//        if(owner == 0){
//            ctx.drawImage(avgWhiteStar, x, y);
//        } else {
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, 2 * Math.PI);
            var gradient = ctx.createRadialGradient(x, y, 2, x, y, 8);
            gradient.addColorStop(0, getPlayerColor(parseInt(owner, 10)));
            gradient.addColorStop(1, "black");
            ctx.fillStyle = gradient;
            ctx.fill();
//        }
    }

    function drawShip(x, y, ships, destination, owner, isSelected, ctx){
        ctx.fillStyle="#FFFFFF";
        x = parseInt(x, 10);
        y = parseInt(y, 10);
        ctx.fillText(ships, x, y + 20);
        ctx.beginPath();
        ctx.moveTo(x,y);
        ctx.lineTo(x-4,y-3);
        ctx.lineTo(x-4,y+3);
        ctx.fill();
        for(i=0; i < map.MAP.length; i++){
            if(map.MAP[i].i.type=="star"){
                if(map.MAP[i].i.id == destination){
                    ctx.strokeStyle=getPlayerColor(parseInt(owner, 10));
                    if(isSelected){
                        ctx.setLineDash([]);
                        ctx.lineWidth=2;
                    } else {
                        ctx.setLineDash([2, 2]);
                        ctx.lineWidth=1;
                    }
                    ctx.beginPath();
                    ctx.moveTo(x,y);
                    ctx.lineTo(map.MAP[i].i.x, map.MAP[i].i.y);
                    ctx.stroke();
                }
            }
        }
    }

    function clearMap(canvas, ctx){
        ctx.fillStyle="black";
        ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function getPlayerColor(player){
        switch(player) {
            case 0:
                return "#FFFFFF";
            case 1:
                return "#8EB9FE"; //blue
            case 2:
                return "#B4FE8E"; //green
            case 3:
                return "#FEE28E"; //yellow
            case 4:
                return "#FE8EE9"; //pink
        }
    }
</script>
</body>
</html>